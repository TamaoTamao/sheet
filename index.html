<DOCUMENT filename="index.html">
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D20 character sheet</title>
    <style>
        :root {
            --color-parchment: #f4e8d0;
            --color-parchment-dark: #e6d5b8;
            --color-parchment-darker: #d4c3a5;
            --color-ink: #2c1810;
            --color-ink-light: #4a3428;
            --color-accent-gold: #8b6914;
            --color-accent-red: #8b2e1f;
            --color-border-dark: #5d4a3a;
            --color-success: #4a7c4e;
            --color-warning: #a67c3a;
            --color-danger: #8b2e1f;
            --color-hp-yellow: #c19a3d;
            --color-hp-green: #4a7c4e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            background: linear-gradient(135deg, #c9b89a 0%, #e6d5b8 50%, #c9b89a 100%);
            color: var(--color-ink);
            padding: 20px;
            line-height: 1.6;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 600px;
            background-image: url('https://agi-prod-file-upload-public-main-use1.s3.amazonaws.com/e1faea3b-6c21-44a1-a2d1-d016eb553111');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.03;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .top-right-controls {
            position: absolute;
            top: -10px;
            right: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
      .toggle-core {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 4px;
  gap: 6px;
  transform: scale(0.95);
  user-select: none;
}

/* language 2x2 */
.toggle-grid.grid-2x2 {
  display: grid;
  grid-template-columns: repeat(2, auto);
  grid-template-rows: repeat(2, auto);
  gap: 6px;
}

/* mode row */
.toggle-row { display:flex; gap:6px; align-items:center; }

/* circles (small) */
.toggle-core .circle {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 0.6rem;
  font-weight: 700;
  color: var(--color-parchment);
  background: var(--color-parchment-darker);
  transition: transform 180ms ease, opacity 180ms ease, background-color 180ms;
  box-shadow: 0 1px 2px rgba(44,24,16,0.18);
  pointer-events: auto;
}

/* active = normal size; inactive = half size */
.toggle-core .circle.active {
  transform: scale(1);
  opacity: 1;
  background: var(--color-accent-gold);
  color: var(--color-parchment);
}
.toggle-core .circle.inactive {
  transform: scale(0.5);
  opacity: 0.5;
  background: var(--color-parchment-darker);
  color: var(--color-parchment);
     border: 1px solid rgba(0,0,0,0.9);
  box-shadow: 0 1px 2px rgba(44,24,16,0.18), inset 0 0 0 1px rgba(0,0,0,0.03);
  border-radius: 50%;
}

/* lens slightly larger than circle to form outline */
.toggle-core .lens {
  position: absolute;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 2px solid rgba(44,24,16,0.95);
  background: transparent;
  pointer-events: none;
  box-shadow: 0 1px 0 var(--color-parchment);
  transition: left 180ms ease, top 180ms ease;
  z-index: 10;
}

        /* Mode‑specific colors: only for the mode toggle (read / edit) */
/* Read = зелёный, Edit = красный (active state) */
.mode-toggle .circle[data-mode="read"].active {
  background: var(--color-hp-green);
  color: var(--color-parchment);
}
.mode-toggle .circle[data-mode="edit"].active {
  background: var(--color-accent-red);
  color: var(--color-parchment);
}

/* Optionally ensure inactive mode visuals (applies to mode toggle too) */
.mode-toggle .circle.inactive {
  background: var(--color-parchment-darker) !important;
  color: var(--color-parchment) !important;
  opacity: 0.5;
  transform: scale(0.5);
}

/* Keep language toggle colors unchanged — ensure generic .toggle-core .circle.active remains in effect for lang */
.lang-toggle .circle.active {
  /* Intentionally empty — fall back to .toggle-core .circle.active (gold) */
}

/* Inline tooltip style (JS toggles presence) */
.inline-tooltip {
  position: absolute;
  bottom: -40px;
  right: 0;
  background: rgba(244,232,208,0.95);
  color: var(--color-ink);
  padding: 6px 10px;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(44,24,16,0.18);
  font-size: 0.85rem;
  z-index: 50;
  white-space: nowrap;
}

/* center toast */
.center-toast {
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) scale(0.98);
  background: rgba(244,232,208,0.95);
  color: var(--color-ink);
  padding: 12px 16px;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(44,24,16,0.25);
  font-weight: 700;
  z-index: 9999;
  opacity: 0;
  transition: opacity 200ms, transform 200ms;
}
.center-toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

/* small-screen safety */
@media (max-width: 640px) {
  h1 { margin-top: 42px; }
  .top-right-controls { right: 8px; top: 6px; gap: 8px; }
}

        .compact-input {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .compact-input label {
            flex: 0 0 auto;
            min-width: 120px;
        }

        .compact-input input {
            width: 80px;
            padding: 6px 8px;
        }

        .inline-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .inline-input label {
            flex: 0 0 auto;
        }

        .inline-input input[type="number"] {
            width: 70px;
            padding: 6px 8px;
        }

        .inline-input input[type="text"] {
            width: 120px;
            padding: 6px 8px;
        }

        h1 {
            color: #fff;
            margin-bottom: 12px;
            font-size: 1.4rem;
            font-weight: bold;
            text-align: center;
            text-shadow: 
                0 3px 6px rgba(74, 52, 40, 0.8),
                0 6px 12px rgba(74, 52, 40, 0.7),
                0 9px 18px rgba(74, 52, 40, 0.6),
                0 12px 24px rgba(74, 52, 40, 0.5),
                0 15px 30px rgba(74, 52, 40, 0.4),
                1px 1px 3px rgba(44, 24, 16, 0.9),
                -1px -1px 3px rgba(44, 24, 16, 0.9),
                2px 2px 6px rgba(44, 24, 16, 0.8),
                -2px -2px 6px rgba(44, 24, 16, 0.8);
            letter-spacing: 1px;
            font-variant: small-caps;
        }

        h2 {
            color: #fff;
            margin: 20px 0 12px;
            font-size: 1.4rem;
            border-bottom: 3px double var(--color-accent-gold);
            padding-bottom: 8px;
            font-weight: bold;
            font-variant: small-caps;
            letter-spacing: 1px;
            text-shadow: 
                0 2px 5px rgba(74, 52, 40, 0.8),
                0 4px 10px rgba(74, 52, 40, 0.7),
                0 6px 15px rgba(74, 52, 40, 0.6),
                0 8px 20px rgba(74, 52, 40, 0.5),
                1px 1px 2px rgba(44, 24, 16, 0.9),
                -1px -1px 2px rgba(44, 24, 16, 0.9);
        }

        .section {
            background: var(--color-parchment);
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            box-shadow: 
                0 4px 8px rgba(44, 24, 16, 0.15), 
                inset 0 0 30px rgba(212, 195, 165, 0.3);
            position: relative;
        }

        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                url('https://agi-prod-file-upload-public-main-use1.s3.amazonaws.com/fee152f2-a72d-40e3-8a44-742260cdc187');
            background-size: 400px;
            background-repeat: repeat;
            opacity: 0.15;
            pointer-events: none;
            border-radius: 4px;
        }

        .section::after {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border-width: 0,1px;
            border-color: #fff
            border-style: solid;
            border-radius: 4px;
            pointer-events: none;
        }

        .grid {
            display: grid;
            gap: 12px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #fff;
            text-shadow: 
                0 1px 3px rgba(74, 52, 40, 0.8),
                0 2px 6px rgba(74, 52, 40, 0.7),
                0 3px 9px rgba(74, 52, 40, 0.6),
                0 4px 12px rgba(74, 52, 40, 0.5),
                1px 1px 2px rgba(44, 24, 16, 0.9),
                -1px -1px 2px rgba(44, 24, 16, 0.9);
        }

        input, textarea, select {
            padding: 10px 12px;
            background: var(--color-parchment-dark);
            border: none;
            border-radius: 0;
            color: var(--color-ink);
            font-size: 1rem;
            transition: all 0.2s;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--color-accent-gold);
            background: var(--color-parchment);
            box-shadow: 0 0 8px rgba(139, 105, 20, 0.3);
        }

        textarea {
            resize: none;
            min-height: 80px;
            font-family: inherit;
            width: 100%;
            box-sizing: border-box;
        }


        .item-details {
            font-size: 0.85rem;
            color: var(--color-ink-light);
            font-style: italic;
        }
        
        .item-details input,
        .item-details textarea {
            font-family: inherit;
            font-style: inherit;
            font-size: inherit;
            max-width: 100%;
            box-sizing: border-box;
        }

        .stat-compact {
            background: var(--color-parchment-dark);
            padding: 12px;
            border-radius: 50%;
            text-align: center;
            box-shadow: 
                inset 0 2px 4px rgba(44, 24, 16, 0.1),
                0 4px 8px rgba(44, 24, 16, 0.2);
            position: relative;
            width: 90px;
            height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stat-compact::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('https://agi-prod-file-upload-public-main-use1.s3.amazonaws.com/fee152f2-a72d-40e3-8a44-742260cdc187');
            background-size: 200px;
            opacity: 0.1;
            pointer-events: none;
            border-radius: 50%;
        }

        .stat-compact label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .stat-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
        }

        .stat-value {
            width: 45px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 4px;
            background: transparent;
            border: none;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        .stat-value::-webkit-inner-spin-button,
        .stat-value::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .stat-mod {
            width: 40px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 4px;
            background: var(--color-parchment-darker);
            color: var(--color-accent-red);
            border-radius: 12px;
        }

        .btn {
            padding: 10px 20px;
            background: var(--color-accent-gold);
            color: var(--color-parchment);
            border: none;
            border-radius: 3px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .btn:hover {
            background: var(--color-ink-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(44, 24, 16, 0.3);
        }

        .btn-secondary {
            background: var(--color-parchment-darker);
            color: var(--color-ink);
            text-shadow: none;
        }

        .btn-secondary:hover {
            background: var(--color-parchment-dark);
        }

        .btn-danger {
            background: var(--color-danger);
            color: var(--color-parchment);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.875rem;
        }

        .btn-micro {
            width: 1rem;
            height: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border-radius: 0.2rem;
            font-size: 0.8rem;
        }


        .item {
            background: var(--color-parchment-dark);
            padding: 12px;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 8px;
            box-sizing: border-box;
        }

        .item-info {
            flex: 1 1 auto;
            min-width: 0;
        }

        .item-name {
            font-weight: 700;
            color: #fff;
            text-shadow: 
                0 1px 3px rgba(74, 52, 40, 0.8),
                0 2px 6px rgba(74, 52, 40, 0.7),
                0 3px 9px rgba(74, 52, 40, 0.6),
                0 4px 12px rgba(74, 52, 40, 0.5),
                1px 1px 2px rgba(44, 24, 16, 0.9),
                -1px -1px 2px rgba(44, 24, 16, 0.9);
        }

        .item-details {
            font-size: 0.875rem;
            color: var(--color-ink-light);
            margin-top: 4px;
            font-style: italic;
            word-wrap: break-word;
            overflow-wrap: anywhere;
        }

        .item-details textarea {
            max-width: 100%;
            box-sizing: border-box;
        }

        .item-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .counter {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--color-parchment);
            padding: 4px 8px;
            border-radius: 3px;
        }

        .counter button {
            width: 28px;
            height: 28px;
            background: var(--color-accent-gold);
            color: var(--color-parchment);
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 1.25rem;
            line-height: 1;
            transition: all 0.2s;
            font-weight: bold;
        }

        .counter button:hover {
            background: var(--color-ink-light);
        }

        .counter span {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: var(--color-parchment-darker);
            color: var(--color-ink-light);
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
            font-family: inherit;
            font-variant: small-caps;
        }

        .tab.active {
            background: var(--color-accent-gold);
            color: var(--color-parchment);
            border-color: var(--color-ink);
            box-shadow: inset 0 2px 4px rgba(44, 24, 16, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .add-form {
            background: var(--color-parchment-darker);
            padding: 16px;
            border-radius: 3px;
            margin-bottom: 16px;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .form-row > * {
            flex: 1;
            min-width: 200px;
        }

        .health-bar {
            margin-top: 12px;
        }

        .health-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 12px; /* было 18px */
            background: var(--color-parchment-darker);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.4);
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s, background-color 0.2s ease;
            border-radius: 4px;
        }


        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-ink-light);
            font-style: italic;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .stat-box input {
                font-size: 1.25rem;
            }
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    
    <div class="top-right-controls">
  <div class="toggle-core lang-toggle" id="langToggle" role="button" tabindex="0" aria-label="Язык" data-selected="ru">
    <div class="toggle-grid grid-2x2" aria-hidden="true">
      <div class="circle" data-lang="ru" aria-label="Русский">RU</div>
      <div class="circle" data-lang="en" aria-label="English">EN</div>
      <div class="circle" data-lang="es" aria-label="Español">ES</div>
      <div class="circle" data-lang="fr" aria-label="Français">FR</div>
    </div>
    <div class="lens" aria-hidden="true"></div>
  </div>

  <div class="toggle-core mode-toggle" id="modeToggle" role="button" tabindex="0" aria-label="Режим" data-state="edit">
    <div class="toggle-row" aria-hidden="true">
      <div class="circle" data-mode="read" aria-label="Режим чтения"></div>
      <div class="circle" data-mode="edit" aria-label="Режим редактирования"></div>
    </div>
    <div class="lens" aria-hidden="true"></div>
  </div>
</div>

        <h1>D20 лист персонажа</h1>

        <div class="tabs">
            <button class="tab active" data-tab="character">Персонаж</button>
            <button class="tab" data-tab="skills">Навыки</button>
            <button class="tab" data-tab="spells">Заклинания</button>
            <button class="tab" data-tab="inventory">Инвентарь</button>
        </div>

        <div id="character" class="tab-content active">
            <div class="section">
                <h2>Основная информация</h2>
                <div class="input-group" style="margin-bottom: 12px;">
                    <label for="charName">Имя персонажа</label>
                    <input type="text" id="charName" placeholder="Введите имя">
                </div>
                <div class="input-group" style="margin-bottom: 12px;">
                    <label for="charRace">Раса</label>
                    <input type="text" id="charRace" placeholder="Человек, эльф, дворф...">
                </div>
                <div style="display: flex; gap: 12px; align-items: flex-end; margin-bottom: 12px;">
                    <div class="input-group" style="flex: 1;">
                        <label for="charClass">Класс</label>
                        <input type="text" id="charClass" placeholder="Воин, бард, чародей...">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Характеристики</h2>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 700px; margin: 0 auto;">
                    <div class="stat-compact">
                        <label>СИЛ</label>
                        <div class="stat-row">
                            <input type="number" id="statStr" value="10" min="1" max="30" class="stat-value">
                            <input type="text" id="modStr" value="+0" class="stat-mod" readonly>
                        </div>
                    </div>
                    <div class="stat-compact">
                        <label>ЛВК</label>
                        <div class="stat-row">
                            <input type="number" id="statDex" value="10" min="1" max="30" class="stat-value">
                            <input type="text" id="modDex" value="+0" class="stat-mod" readonly>
                        </div>
                    </div>
                    <div class="stat-compact">
                        <label>ТЕЛ</label>
                        <div class="stat-row">
                            <input type="number" id="statCon" value="10" min="1" max="30" class="stat-value">
                            <input type="text" id="modCon" value="+0" class="stat-mod" readonly>
                        </div>
                    </div>
                    <div class="stat-compact">
                        <label>ИНТ</label>
                        <div class="stat-row">
                            <input type="number" id="statInt" value="10" min="1" max="30" class="stat-value">
                            <input type="text" id="modInt" value="+0" class="stat-mod" readonly>
                        </div>
                    </div>
                    <div class="stat-compact">
                        <label>МДР</label>
                        <div class="stat-row">
                            <input type="number" id="statWis" value="10" min="1" max="30" class="stat-value">
                            <input type="text" id="modWis" value="+0" class="stat-mod" readonly>
                        </div>
                    </div>
                    <div class="stat-compact">
                        <label>ХАР</label>
                        <div class="stat-row">
                            <input type="number" id="statCha" value="10" min="1" max="30" class="stat-value">
                            <input type="text" id="modCha" value="+0" class="stat-mod" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Здоровье и ресурсы</h2>
                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
                    <label for="currentHP" style="white-space: nowrap;">Текущее HP</label>
                    <input type="number" id="currentHP" value="20" min="0" style="width: 80px;">
                    <label for="maxHP" style="white-space: nowrap;">Максимальное HP</label>
                    <input type="number" id="maxHP" value="20" min="1" style="width: 80px;">
                </div>
                <div class="health-bar" style="margin-bottom: 16px;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="hpBar" style="width: 100%"></div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <label for="armorClass" style="white-space: nowrap;">Класс доспеха</label>
                    <input type="number" id="armorClass" value="10" min="0" style="width: 80px;">
                    <label for="speed" style="white-space: nowrap;">Скорость</label>
                    <input type="number" id="speed" value="30" min="0" style="width: 80px;">
                </div>
            </div>

            <div class="section">
                <h2>Заметки</h2>
                <textarea id="notes" placeholder="Заметки о персонаже, история, особенности..."></textarea>
            </div>

            <div class="section">
                <button class="btn" id="saveBtn">Сохранить персонажа</button>
                <button class="btn btn-secondary" id="loadBtn" style="margin-left: 12px;">Загрузить персонажа</button>
            </div>
        </div>

        <div id="skills" class="tab-content">
            <div class="section">
                <h2>Навыки</h2>
                <div id="skillsList"></div>
                <div id="skillsAdd" style="margin-top:12px;">
                    <input type="text" id="newSkillName" placeholder="Добавить навык">
                    <div id="skillsExtraFields" style="display:none; margin-top:8px;">
                        <input type="text" id="newSkillBonus" placeholder="бонус +0">
                        <button class="btn btn-small" id="addSkillBtn">Добавить</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="spells" class="tab-content">
            <div class="section">
                <h2>Заклинания</h2>
                <div id="spellsList"></div>
                <div id="spellsAdd" style="margin-top:12px;">
                    <input type="text" id="newSpellName" placeholder="Добавить заклинание">
                    <div id="spellsExtraFields" style="display:none; margin-top:8px;">
                        <div class="form-row">
                            <div class="inline-input">
                                <input type="number" id="newSpellLevel" placeholder="Уровень заклинания" min="0" max="9">
                            </div>
                            <div class="inline-input">
                                <input type="number" id="newSpellSlots" placeholder="Доступные слоты" min="0">
                            </div>
                        </div>
                        <div class="input-group">
                            <textarea id="newSpellDesc" placeholder="Эффект заклинания" style="min-height:60px;"></textarea>
                        </div>
                        <button class="btn btn-small" id="addSpellBtn">Добавить</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="inventory" class="tab-content">
            <div class="section">
                <h2>Инвентарь</h2>
                <div id="inventoryList"></div>
                <div id="itemsAdd" style="margin-top: 16px;">
                    <input type="text" id="ItemName" placeholder="Добавить предмет">
                    <div id="itemsExtraFields" style="display:none; margin-top: 8px;">
                        <div class="form-row">
                            <div class="inline-input">
                                <input type="number" id="ItemQuantity" placeholder="Количество" min="0">
                            </div>
                            <div class="inline-input">
                                <input type="text" id="ItemPrice" placeholder="Рыночная стоимость" min="0">
                            </div>
                        </div>
                        <div class="input-group">
                            <textarea id="ItemDesc" placeholder="Свойства" style="min-height:60px;"></textarea>
                        </div>
                        <button class="btn btn-small" id="addItemBtn">Добавить</button>
                    </div>
                </div>
                <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid var(--color-parchment-darker);">
                    <div class="compact-input">
                        <label for="pp">Платиновые</label>
                        <input type="number" id="pp" value="0" min="0">
                    </div>
                    <div class="compact-input">
                        <label for="gp">Золотые</label>
                        <input type="number" id="gp" value="0" min="0">
                    </div>
                    <div class="compact-input">
                        <label for="sp">Серебряные</label>
                        <input type="number" id="sp" value="0" min="0">
                    </div>
                    <div class="compact-input">
                        <label for="cp">Медные</label>
                        <input type="number" id="cp" value="0" min="0">
                    </div>
                    <div class="compact-input">
                        <label for="inventoryTotal">Общая стоимость инвентаря</label>
                        <input type="text" id="inventoryTotal" placeholder="0 зм. пока что" readonly style="background: var(--color-parchment-darker);">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        
    // --------------------
    // ВСТРОЕННЫЕ СЛОВАРИ (on-board dictionaries)
    // --------------------
        
// Full JS block for index.html (exclude external libraries). Paste into a <script> tag.
// Implements translations, UI logic, tabs, data model, persistence, and unified toggles.

const translations = {
    en: {
        title: 'D20 Character Sheet',
        tabCharacter: 'Character',
        tabSkills: 'Skills',
        tabSpells: 'Spells',
        tabInventory: 'Inventory',
        basicInfo: 'Basic Information',
        charName: 'Character Name',
        charNamePlaceholder: 'Enter name',
        charClass: 'Class',
        charClassPlaceholder: 'Warrior, mage, rogue...',
        charRace: 'Race',
        charRacePlaceholder: 'Human, elf, dwarf...',
        stats: 'Ability Scores',
        statStr: 'STR',
        statDex: 'DEX',
        statCon: 'CON',
        statInt: 'INT',
        statWis: 'WIS',
        statCha: 'CHA',
        health: 'Health and Resources',
        currentHP: 'Current HP',
        maxHP: 'Max HP',
        armorClass: 'Armor Class',
        speed: 'Speed',
        notes: 'Notes',
        notesPlaceholder: 'Character notes, background, traits...',
        saveBtn: 'Save Character',
        loadBtn: 'Load Character',
        skills: 'Skills',
        skillName: 'Skill Name',
        skillNamePlaceholder: 'New skill',
        skillBonus: 'Bonus',
        skillBonusPlaceholder: '+5 bonus',
        addSkill: 'Add Skill',
        spells: 'Spells',
        spellName: 'Spell Name',
        spellNamePlaceholder: 'New spell',
        spellLevel: 'Level',
        spellSlots: 'Slots (total)',
        spellDesc: 'Description',
        spellDescPlaceholder: 'Effect',
        addSpell: 'Add Spell',
        inventory: 'Inventory',
        coinsPP: 'Platinum',
        coinsGP: 'Gold',
        coinsSP: 'Silver',
        coinsCP: 'Copper',
        totalValue: 'Total Value',
        itemName: 'Item Name',
        itemNamePlaceholder: 'New item',
        itemQuantity: 'Quantity',
        itemPrice: 'Market Price',
        itemPricePlaceholder: 'some gp',
        itemDesc: 'Description',
        itemDescPlaceholder: 'Properties',
        addItem: 'Add Item',
        noSkills: 'No skills added',
        noSpells: 'No spells added',
        noItems: 'Inventory empty',
        savedMsg: 'Character encoded and copied to clipboard!',
        loadedMsg: 'Character loaded!',
        errorMsg: 'Decoding error. Check the input string.',
        loadPrompt: 'Paste encoded character data:'
    },
    ru: {
        title: 'D20 лист персонажа',
        tabCharacter: 'Персонаж',
        tabSkills: 'Навыки',
        tabSpells: 'Заклинания',
        tabInventory: 'Инвентарь',
        basicInfo: 'Основная информация',
        charName: 'Имя персонажа',
        charNamePlaceholder: 'Введите имя',
        charClass: 'Класс',
        charClassPlaceholder: 'Воин, маг, вор...',
        charRace: 'Раса',
        charRacePlaceholder: 'Человек, эльф, дворф...',
        stats: 'Характеристики',
        statStr: 'СИЛ',
        statDex: 'ЛВК',
        statCon: 'ТЕЛ',
        statInt: 'ИНТ',
        statWis: 'МДР',
        statCha: 'ХАР',
        health: 'Здоровье и ресурсы',
        currentHP: 'Текущее HP',
        maxHP: 'Максимальное HP',
        armorClass: 'Класс доспеха',
        speed: 'Скорость',
        notes: 'Заметки',
        notesPlaceholder: 'Заметки о персонаже, история, особенности...',
        saveBtn: 'Сохранить персонажа',
        loadBtn: 'Загрузить персонажа',
        skills: 'Навыки',
        skillName: 'Название навыка',
        skillNamePlaceholder: 'Добавить навык',
        skillBonus: 'Бонус',
        skillBonusPlaceholder: '+5 бонус',
        addSkill: 'Добавить навык',
        spells: 'Заклинания',
        spellName: 'Название заклинания',
        spellNamePlaceholder: 'Добавить заклинание',
        spellLevel: 'Уровень',
        spellSlots: 'Слоты (всего)',
        spellDesc: 'Описание',
        spellDescPlaceholder: 'Эффект заклинания',
        addSpell: 'Добавить заклинание',
        inventory: 'Инвентарь',
        coinsPP: 'Платиновые',
        coinsGP: 'Золотые',
        coinsSP: 'Серебряные',
        coinsCP: 'Медные',
        totalValue: 'Общая стоимость инвентаря',
        itemName: 'Название предмета',
        itemNamePlaceholder: 'Добавить предмет',
        itemQuantity: 'Количество',
        itemPrice: 'Рыночная стоимость',
        itemPricePlaceholder: 'несколько зм',
        itemDesc: 'Описание',
        itemDescPlaceholder: 'Свойства предмета',
        addItem: 'Добавить предмет',
        noSkills: 'Навыки не добавлены',
        noSpells: 'Заклинания не добавлены',
        noItems: 'Инвентарь пуст',
        savedMsg: 'Персонаж закодирован и скопирован в буфер обмена!',
        loadedMsg: 'Персонаж загружен!',
        errorMsg: 'Ошибка декодирования данных. Проверьте правильность введенной строки.',
        loadPrompt: 'Вставьте закодированные данные персонажа:'
    },
    fr: {
        title: 'D20 Feuille de Personnage',
        tabCharacter: 'Personnage',
        tabSkills: 'Compétences',
        tabSpells: 'Sorts',
        tabInventory: 'Inventaire',
        basicInfo: 'Informations de Base',
        charName: 'Nom du Personnage',
        charNamePlaceholder: 'Entrez le nom',
        charClass: 'Classe',
        charClassPlaceholder: 'Guerrier, mage, voleur...',
        charRace: 'Race',
        charRacePlaceholder: 'Humain, elfe, nain...',
        stats: 'Caractéristiques',
        statStr: 'FOR',
        statDex: 'DEX',
        statCon: 'CON',
        statInt: 'INT',
        statWis: 'SAG',
        statCha: 'CHA',
        health: 'Santé et Ressources',
        currentHP: 'PV Actuels',
        maxHP: 'PV Maximum',
        armorClass: 'Classe d\'Armure',
        speed: 'Vitesse',
        notes: 'Notes',
        notesPlaceholder: 'Notes sur le personnage, histoire, particularités...',
        saveBtn: 'Sauvegarder',
        loadBtn: 'Charger',
        skills: 'Compétences',
        skillName: 'Nom de la Compétence',
        skillNamePlaceholder: 'Nouvelle compétence',
        skillBonus: 'Bonus',
        skillBonusPlaceholder: '+5 bonus',
        addSkill: 'Ajouter Compétence',
        spells: 'Sorts',
        spellName: 'Nom du Sort',
        spellNamePlaceholder: 'Nouveau sort',
        spellLevel: 'Niveau',
        spellSlots: 'Emplacements (total)',
        spellDesc: 'Description',
        spellDescPlaceholder: 'Effet du sort',
        addSpell: 'Ajouter Sort',
        inventory: 'Inventaire',
        coinsPP: 'Platine',
        coinsGP: 'Or',
        coinsSP: 'Argent',
        coinsCP: 'Cuivre',
        totalValue: 'Valeur Totale',
        itemName: 'Nom de l\'Objet',
        itemNamePlaceholder: 'Nouvel objet',
        itemQuantity: 'Quantité',
        itemPrice: 'Prix du Marché',
        itemPricePlaceholder: 'plusieurs ors',
        itemDesc: 'Description',
        itemDescPlaceholder: 'Propriétés de l\'objet...',
        addItem: 'Ajouter Objet',
        noSkills: 'Aucune compétence ajoutée',
        noSpells: 'Aucun sort ajouté',
        noItems: 'Inventaire vide',
        savedMsg: 'Personnage encodé et copié dans le presse-papier!',
        loadedMsg: 'Personnage chargé!',
        errorMsg: 'Erreur de décodage. Vérifiez la chaîne.',
        loadPrompt: 'Collez les données encodées du personnage:'
    },
    es: {
        title: 'D20 Hoja de Personaje',
        tabCharacter: 'Personaje',
        tabSkills: 'Habilidades',
        tabSpells: 'Hechizos',
        tabInventory: 'Inventario',
        basicInfo: 'Información Básica',
        charName: 'Nombre del Personaje',
        charNamePlaceholder: 'Ingrese el nombre',
        charClass: 'Clase',
        charClassPlaceholder: 'Guerrero, mago, pícaro...',
        charRace: 'Raza',
        charRacePlaceholder: 'Humano, elfo, enano...',
        stats: 'Características',
        statStr: 'FUE',
        statDex: 'DES',
        statCon: 'CON',
        statInt: 'INT',
        statWis: 'SAB',
        statCha: 'CAR',
        health: 'Salud y Recursos',
        currentHP: 'PV Actuales',
        maxHP: 'PV Máximos',
        armorClass: 'Clase de Armadura',
        speed: 'Velocidad',
        notes: 'Notas',
        notesPlaceholder: 'Notas sobre el personaje, historia, características...',
        saveBtn: 'Guardar Personaje',
        loadBtn: 'Cargar Personaje',
        skills: 'Habilidades',
        skillName: 'Nombre de Habilidad',
        skillNamePlaceholder: 'Nueva habilidad',
        skillBonus: 'Bonificación',
        skillBonusPlaceholder: '+5 bonificación',
        addSkill: 'Añadir Habilidad',
        spells: 'Hechizos',
        spellName: 'Nombre del Hechizo',
        spellNamePlaceholder: 'Nuevo hechizo',
        spellLevel: 'Nivel',
        spellSlots: 'Espacios (total)',
        spellDesc: 'Descripción',
        spellDescPlaceholder: 'Efecto del hechizo',
        addSpell: 'Añadir Hechizo',
        inventory: 'Inventario',
        coinsPP: 'Platino',
        coinsGP: 'Oro',
        coinsSP: 'Plata',
        coinsCP: 'Cobre',
        totalValue: 'Valor Total',
        itemName: 'Nombre del Objeto',
        itemNamePlaceholder: 'Nuevo objeto',
        itemQuantity: 'Cantidad',
        itemPrice: 'Precio de Mercado',
        itemPricePlaceholder: 'varios oros',
        itemDesc: 'Descripción',
        itemDescPlaceholder: 'Propiedades del objeto',
        addItem: 'Añadir Objeto',
        noSkills: 'No hay habilidades añadidas',
        noSpells: 'No hay hechizos añadidos',
        noItems: 'Inventario vacío',
        savedMsg: '¡Personaje codificado y copiado al portapapeles!',
        loadedMsg: '¡Personaje cargado!',
        errorMsg: 'Error de decodificación. Verifique la cadena.',
        loadPrompt: 'Pegue los datos codificados del personaje:'
    }
};

(function(){
    const repoProvidedTranslations = window.translations || {};
    const qs  = (sel)=>document.querySelector(sel);
    const qsa = (sel)=>Array.from(document.querySelectorAll(sel));
    
    // скрытый измеритель ширины текста
    const descMeasure = document.createElement('span');
    descMeasure.style.visibility = 'hidden';
    descMeasure.style.whiteSpace = 'pre';
    descMeasure.style.position = 'absolute';
    descMeasure.style.left = '-9999px';
    document.body.appendChild(descMeasure);

    function autosizeDescription(textarea){
        const style = getComputedStyle(textarea);
        descMeasure.style.font = style.font;
        descMeasure.textContent = textarea.value || textarea.placeholder || '';
        const contentWidth = descMeasure.offsetWidth + 10;
        textarea.style.width = contentWidth + 'px';
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    let character = {
        info: { name: '', race: '', class: '', level: 1 },
        stats: { Str: 10, Dex: 10, Con: 10, Int: 10, Wis: 10, Cha: 10 },
        hp: { current: 20, max: 20 },
        armorClass: 10,
        speed: 30,
        notes: '',
        skills: [],
        spells: [],
        inventory: [],
        coins: { pp:0, gp:0, sp:0, cp:0 }
    };

    const COIN_RATES = { pp:10, gp:1, sp:0.1, cp:0.01 };
    let currentLanguage = 'ru';
    const translationsObj = repoProvidedTranslations && Object.keys(repoProvidedTranslations).length
        ? repoProvidedTranslations
        : translations;

    // Tabs
    function initTabs(){
        qsa('.tab').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.getAttribute('data-tab');
                switchTab(tab, btn);
            });
        });
    }
    function switchTab(tabName, btn){
        qsa('.tab').forEach(t=>t.classList.remove('active'));
        qsa('.tab-content').forEach(c=>c.classList.remove('active'));
        if (btn) btn.classList.add('active');
        const el = document.getElementById(tabName);
        if (el) el.classList.add('active');
    }

    // Stats
    function calcMod(score){
        const s = parseInt(score)||0;
        const m = Math.floor((s-10)/2);
        return (m>=0?'+':'')+m;
    }
    function updateStatModifiers(){
        ['Str','Dex','Con','Int','Wis','Cha'].forEach(k=>{
            const statEl = document.getElementById('stat'+k);
            const modEl  = document.getElementById('mod'+k);
            if (!statEl || !modEl) return;
            modEl.value = calcMod(statEl.value);
        });
    }

    // HP bar color
    function lerp(a, b, t){ return a + (b - a) * t; }
    function lerpColor(c1, c2, t){
        const r = Math.round(lerp(c1[0], c2[0], t));
        const g = Math.round(lerp(c1[1], c2[1], t));
        const b = Math.round(lerp(c1[2], c2[2], t));
        return `rgb(${r}, ${g}, ${b})`;
    }
    const HP_RED    = [0x8b, 0x2e, 0x1f];
    const HP_YELLOW = [0xc1, 0x9a, 0x3d];
    const HP_GREEN  = [0x4a, 0x7c, 0x4e];
    function getHpColorByPercent(ratio){
        const t = Math.max(0, Math.min(1, ratio));
        if (t <= 0.5){
            const localT = t / 0.5;
            return lerpColor(HP_RED, HP_YELLOW, localT);
        } else {
            const localT = (t - 0.5) / 0.5;
            return lerpColor(HP_YELLOW, HP_GREEN, localT);
        }
    }
    function updateHealthBar(){
        const cur = parseInt(qs('#currentHP').value) || 0;
        const max = parseInt(qs('#maxHP').value) || 1;
        const bar = qs('#hpBar');
        if (!bar) return;
        const ratio = Math.max(0, Math.min(1, cur / max));
        bar.style.width = (ratio * 100) + '%';
        bar.style.backgroundColor = getHpColorByPercent(ratio);
    }

    // Render lists (skills / spells / inventory)
    function renderSkills(){
        const container = qs('#skillsList'); container.innerHTML = '';
        if (!character.skills.length){
            const empty = document.createElement('div');
            empty.className = 'empty-state';
            empty.textContent = (translationsObj[currentLanguage] && translationsObj[currentLanguage].noSkills) || 'No skills added';
            container.appendChild(empty);
            return;
        }
        character.skills.forEach((s, idx)=>{
            const item = document.createElement('div'); item.className = 'item';
            const info = document.createElement('div'); info.className = 'item-info';
            const nameSpan = document.createElement('span'); nameSpan.textContent = s.name; nameSpan.className = 'item-name';
            const bonusInput = document.createElement('input'); bonusInput.type = 'text'; bonusInput.value = s.bonus || ''; bonusInput.className = 'item-details';
            bonusInput.addEventListener('input', ()=>{ character.skills[idx].bonus = bonusInput.value; });
            info.appendChild(nameSpan); info.appendChild(bonusInput);
            const actions = document.createElement('div'); actions.className = 'item-actions';
            const del = document.createElement('button'); del.className = 'btn btn-small btn-danger btn-micro'; del.textContent = '×';
            del.addEventListener('click', ()=>{ character.skills.splice(idx,1); renderSkills(); });
            actions.appendChild(del); item.appendChild(info); item.appendChild(actions); container.appendChild(item);
        });
    }
    function onNewSkillNameInput(){ const name = qs('#newSkillName').value.trim(); qs('#skillsExtraFields').style.display = name ? 'block' : 'none'; }
    function addSkill(){ const name = qs('#newSkillName').value.trim(); if (!name) return; const bonus = qs('#newSkillBonus').value.trim(); character.skills.push({ name, bonus }); qs('#newSkillName').value = ''; qs('#newSkillBonus').value = ''; qs('#skillsExtraFields').style.display = 'none'; renderSkills(); }

    function renderSpells(){
        const container = qs('#spellsList'); container.innerHTML = '';
        if (!character.spells.length){
            const empty = document.createElement('div'); empty.className = 'empty-state';
            empty.textContent = (translationsObj[currentLanguage] && translationsObj[currentLanguage].noSpells) || 'No spells added';
            container.appendChild(empty); return;
        }
        const t = translationsObj[currentLanguage] || translationsObj['ru'] || {};
        const levelLabelText = t.spellLevel || 'Level';
        const slotsLabelText = t.spellSlots || 'Slots';
        character.spells.forEach((s, idx)=>{
            const item  = document.createElement('div'); item.className = 'item';
            const info  = document.createElement('div'); info.className = 'item-info';
            const name  = document.createElement('div'); name.className = 'item-name'; name.textContent = s.name;
            const details = document.createElement('div'); details.className = 'item-details';
            const metaLine = document.createElement('div');
            const lvlSpan = document.createElement('span'); lvlSpan.textContent = levelLabelText + ': ';
            const lvlInput = document.createElement('input'); lvlInput.type = 'text'; lvlInput.value = (s.level ?? 0).toString(); lvlInput.className = 'item-details'; lvlInput.style.width = '60px';
            lvlInput.addEventListener('input', ()=>{ const raw = lvlInput.value.trim(); const parsed = parseInt(raw, 10); character.spells[idx].level = Number.isNaN(parsed) ? 0 : parsed; });
            const sepSpan = document.createElement('span'); sepSpan.textContent = ' · ';
            const slotsSpan = document.createElement('span'); slotsSpan.textContent = slotsLabelText + ': ';
            const slotsInput = document.createElement('input'); slotsInput.type = 'text'; slotsInput.value = (s.slots ?? 0).toString(); slotsInput.className = 'item-details'; slotsInput.style.width = '60px';
            slotsInput.addEventListener('input', ()=>{ const raw = slotsInput.value.trim(); const parsed = parseInt(raw, 10); character.spells[idx].slots = Number.isNaN(parsed) ? 0 : parsed; });
            metaLine.appendChild(lvlSpan); metaLine.appendChild(lvlInput); metaLine.appendChild(sepSpan); metaLine.appendChild(slotsSpan); metaLine.appendChild(slotsInput);
            const descArea = document.createElement('textarea'); descArea.value = s.desc || ''; descArea.rows  = 1; descArea.style.overflow = 'hidden'; descArea.style.resize   = 'none';
            const autoDesc = ()=> autosizeDescription(descArea);
            descArea.addEventListener('input', ()=>{ character.spells[idx].desc = descArea.value; autoDesc(); });
            setTimeout(autoDesc, 0);
            details.appendChild(metaLine); details.appendChild(descArea);
            info.appendChild(name); info.appendChild(details);
            const actions = document.createElement('div'); actions.className = 'item-actions';
            const del = document.createElement('button'); del.className = 'btn btn-small btn-danger btn-micro'; del.textContent = '×';
            del.addEventListener('click', ()=>{ character.spells.splice(idx,1); renderSpells(); });
            actions.appendChild(del); item.appendChild(info); item.appendChild(actions); container.appendChild(item);
        });
    }
    function onNewSpellNameInput(){ const name=qs('#newSpellName').value.trim(); qs('#spellsExtraFields').style.display = name ? 'block':'none'; }
    function addSpell(){ const name=qs('#newSpellName').value.trim(); if(!name) return; const level=parseInt(qs('#newSpellLevel').value)||0; const slots=parseInt(qs('#newSpellSlots').value)||0; const desc=qs('#newSpellDesc').value.trim(); character.spells.push({name,level,slots,desc}); qs('#newSpellName').value=''; qs('#newSpellDesc').value=''; qs('#newSpellLevel').value=''; qs('#newSpellSlots').value=''; qs('#spellsExtraFields').style.display='none'; renderSpells(); }

    function renderInventory(){
        const container = qs('#inventoryList'); container.innerHTML = '';
        if (!character.inventory.length){
            const empty = document.createElement('div'); empty.className = 'empty-state';
            empty.textContent = (translationsObj[currentLanguage] && translationsObj[currentLanguage].noItems) || 'Inventory is empty';
            container.appendChild(empty); return;
        }
        const t = translationsObj[currentLanguage] || translationsObj['ru'] || {};
        const qtyLabelText   = t.itemQuantity || 'Quantity';
        const priceLabelText = t.itemPrice   || 'Price';
        character.inventory.forEach((it, idx)=>{
            const item  = document.createElement('div'); item.className = 'item';
            const info  = document.createElement('div'); info.className = 'item-info';
            const name  = document.createElement('div'); name.className = 'item-name'; name.textContent = it.name;
            const details = document.createElement('div'); details.className = 'item-details';
            const qtyLine = document.createElement('div');
            const qtyLabelSpan = document.createElement('span'); qtyLabelSpan.textContent = qtyLabelText + ': ';
            const qtyInput = document.createElement('input'); qtyInput.type  = 'text'; qtyInput.value = (it.quantity ?? 1).toString(); qtyInput.className = 'item-details'; qtyInput.style.width = '70px';
            qtyInput.addEventListener('input', ()=>{ const raw = qtyInput.value.trim(); const parsed = parseInt(raw, 10); character.inventory[idx].quantity = Number.isNaN(parsed) ? 1 : parsed; updateInventoryTotal(); });
            qtyLine.appendChild(qtyLabelSpan); qtyLine.appendChild(qtyInput);
            const priceLine = document.createElement('div'); priceLine.textContent = priceLabelText + ': ' + (it.price || '');
            const descArea = document.createElement('textarea'); descArea.value = it.desc || ''; descArea.rows  = 1; descArea.style.overflow = 'hidden'; descArea.style.resize   = 'none';
            const autoItemDesc = ()=> autosizeDescription(descArea);
            descArea.addEventListener('input', ()=>{ character.inventory[idx].desc = descArea.value; autoItemDesc(); });
            setTimeout(autoItemDesc, 0);
            details.appendChild(qtyLine); details.appendChild(priceLine); details.appendChild(descArea);
            info.appendChild(name); info.appendChild(details);
            const actions = document.createElement('div'); actions.className = 'item-actions';
            const del = document.createElement('button'); del.className = 'btn btn-small btn-danger btn-micro'; del.textContent = '×';
            del.addEventListener('click', ()=>{ character.inventory.splice(idx,1); renderInventory(); updateInventoryTotal(); });
            actions.appendChild(del); item.appendChild(info); item.appendChild(actions); container.appendChild(item);
        });
    }
    function onNewItemNameInput(){ const name=qs('#ItemName').value.trim(); qs('#itemsExtraFields').style.display = name ? 'block':'none'; }
    function addItem(){ const name=qs('#ItemName').value.trim(); if(!name) return; const qty=parseInt(qs('#ItemQuantity').value)||1; const price=qs('#ItemPrice').value.trim(); const desc=qs('#ItemDesc').value.trim(); character.inventory.push({name,quantity:qty,price,desc}); qs('#ItemName').value=''; qs('#ItemQuantity').value=''; qs('#ItemPrice').value=''; qs('#ItemDesc').value=''; qs('#itemsExtraFields').style.display='none'; renderInventory(); updateInventoryTotal(); }

    function hasStem(word, stem, endings){ if (!word.includes(stem)) return false; return endings.some(end => word.endsWith(end)); }
    function parsePriceToGP(priceStr){
        if (!priceStr) return 0;
        const s = String(priceStr).toLowerCase();
        const numMatch = s.match(/([-+]?\d*\.?\d+)/);
        if (!numMatch) return 0;
        const val = parseFloat(numMatch[1]); if (isNaN(val)) return 0;
        const unitMap = [
            { unit: 'pp', match: str => ['pp','platinum','пм', 'пп'].some(k => str.includes(k)) || hasStem(str, 'платин', ['а','ы']) },
            { unit: 'gp', match: str => ['gp','gold','зм', 'гп'].some(k => str.includes(k)) || hasStem(str, 'золо', ['то','та','тых']) || hasStem(str, 'голд', ['','а','ы']) || hasStem(str, 'руб',  ['','ль','ля','лей']) },
            { unit: 'sp', match: str => ['sp','silver','см', 'сп'].some(k => str.includes(k)) || hasStem(str, 'серебр', ['о','а']) },
            { unit: 'cp', match: str => ['cp','copper','мм', 'кп'].some(k => str.includes(k)) || hasStem(str, 'мед',  ['ь','и','як','яка','яки','яков']) || hasStem(str, 'коп', ['','ейка','ейки','еек']) }
        ];
        let unit = 'gp';
        const found = unitMap.find(m => m.match(s));
        if (found) unit = found.unit;
        switch(unit){
            case 'pp': return val * COIN_RATES.pp;
            case 'sp': return val * COIN_RATES.sp;
            case 'cp': return val * COIN_RATES.cp;
            default:   return val;
        }
    }
    function updateInventoryTotal(){
        const pp=parseFloat(qs('#pp').value)||0; const gp=parseFloat(qs('#gp').value)||0; const sp=parseFloat(qs('#sp').value)||0; const cp=parseFloat(qs('#cp').value)||0;
        let total = pp*COIN_RATES.pp + gp*COIN_RATES.gp + sp*COIN_RATES.sp + cp*COIN_RATES.cp;
        character.inventory.forEach(it=>{ total += parsePriceToGP(it.price) * (it.quantity||1); });
        qs('#inventoryTotal').value = total.toFixed(2) + ' gp';
    }

    // Edit mode
    let isEditMode = true;
    function applyEditMode(){ const root = document.documentElement; if (isEditMode) root.classList.remove('readonly'); else root.classList.add('readonly'); }

    // i18n
    function initLanguage(){ setLanguage(currentLanguage); }
    function setLanguage(lang){
        if (!translationsObj[lang]) lang = 'ru';
        currentLanguage = lang;
        const toggle = qs('#langToggle'); if (toggle) toggle.dataset.selected = lang;
        updateLanguage();
    }
    function updateLanguage(){
        const t = translationsObj[currentLanguage] || translationsObj['ru'] || {}; if (!t) return;
        const h1 = qs('h1'); if (h1) h1.textContent = t.title || 'D20 character sheet';
        const tabs = qsa('.tab'); if (tabs[0]) tabs[0].textContent = t.tabCharacter || 'Character'; if (tabs[1]) tabs[1].textContent = t.tabSkills || 'Skills'; if (tabs[2]) tabs[2].textContent = t.tabSpells || 'Spells'; if (tabs[3]) tabs[3].textContent = t.tabInventory || 'Inventory';
        const charH2 = qsa('#character .section h2'); if (charH2[0]) charH2[0].textContent = t.basicInfo || ''; if (charH2[1]) charH2[1].textContent = t.stats || ''; if (charH2[2]) charH2[2].textContent = t.health || ''; if (charH2[3]) charH2[3].textContent = t.notes || '';
        const skillsH2 = qs('#skills h2'); if (skillsH2) skillsH2.textContent = t.skills || 'Skills';
        const spellsH2 = qs('#spells h2'); if (spellsH2) spellsH2.textContent = t.spells || 'Spells';
        const invH2 = qs('#inventory h2'); if (invH2) invH2.textContent = t.inventory || 'Inventory';
        const setLabel = (sel, txt)=>{ const el = qs(sel); if (el) el.textContent = txt; };
        const setPh = (id, txt)=>{ const el = document.getElementById(id); if (el) el.placeholder = txt; };
        setLabel('label[for="charName"]', t.charName || 'Character Name'); setPh('charName', t.charNamePlaceholder || 'Enter name');
        setLabel('label[for="charRace"]', t.charRace || 'Race'); setPh('charRace', t.charRacePlaceholder || 'Human, elf...');
        setLabel('label[for="charClass"]', t.charClass || 'Class'); setPh('charClass', t.charClassPlaceholder || 'Warrior...');
        const statLabels = qsa('.stat-compact label'); if (statLabels[0]) statLabels[0].textContent = t.statStr || 'STR'; if (statLabels[1]) statLabels[1].textContent = t.statDex || 'DEX'; if (statLabels[2]) statLabels[2].textContent = t.statCon || 'CON'; if (statLabels[3]) statLabels[3].textContent = t.statInt || 'INT'; if (statLabels[4]) statLabels[4].textContent = t.statWis || 'WIS'; if (statLabels[5]) statLabels[5].textContent = t.statCha || 'CHA';
        setLabel('label[for="currentHP"]', t.currentHP || 'Current HP'); setLabel('label[for="maxHP"]', t.maxHP || 'Maximum HP'); setLabel('label[for="armorClass"]', t.armorClass || 'Armor Class'); setLabel('label[for="speed"]', t.speed || 'Speed'); setPh('notes', t.notesPlaceholder || 'Notes...');
        const saveBtn = qs('#saveBtn'); if (saveBtn) saveBtn.textContent = t.saveBtn || 'Save Character'; const loadBtn = qs('#loadBtn'); if (loadBtn) loadBtn.textContent = t.loadBtn || 'Load Character';
        setPh('newSkillName', t.skillNamePlaceholder || 'New skill'); setPh('newSkillBonus', t.skillBonusPlaceholder || '+0'); const addSkillBtn = qs('#addSkillBtn'); if (addSkillBtn) addSkillBtn.textContent = t.addSkill || 'Add Skill';
        setPh('newSpellName', t.spellNamePlaceholder || 'New spell'); setPh('newSpellDesc', t.spellDescPlaceholder || 'Spell effect'); const addSpellBtn = qs('#addSpellBtn'); if (addSpellBtn) addSpellBtn.textContent = t.addSpell || 'Add Spell';
        setPh('ItemName', t.itemNamePlaceholder || 'New item'); setPh('ItemPrice', t.itemPricePlaceholder || 'some gp'); setPh('ItemDesc', t.itemDescPlaceholder || 'Item properties'); const addItemBtn = qs('#addItemBtn'); if (addItemBtn) addItemBtn.textContent = t.addItem || 'Add Item';
        setLabel('label[for="pp"]', t.coinsPP || 'Platinum'); setLabel('label[for="gp"]', t.coinsGP || 'Gold'); setLabel('label[for="sp"]', t.coinsSP || 'Silver'); setLabel('label[for="cp"]', t.coinsCP || 'Copper'); setLabel('label[for="inventoryTotal"]', t.totalValue || 'Total Inventory Value');
        renderSkills(); renderSpells(); renderInventory(); updateInventoryTotal();
    }

    // persistence
    function encodeCharacter(){ const payload = Object.assign({}, character, { _meta:{ver:1} }); return btoa(unescape(encodeURIComponent(JSON.stringify(payload)))); }
    function decodeCharacter(str){ try{ const json = decodeURIComponent(escape(atob(str))); return JSON.parse(json); }catch(e){ return null; } }

    function saveCharacter(){
        character.info.name  = qs('#charName').value.trim();
        character.info.race  = qs('#charRace').value.trim();
        character.info.class = qs('#charClass').value.trim();
        ['Str','Dex','Con','Int','Wis','Cha'].forEach(k=>{ const el=document.getElementById('stat'+k); if(el) character.stats[k]=parseInt(el.value)||10; });
        character.hp.current = parseInt(qs('#currentHP').value)||0;
        character.hp.max     = parseInt(qs('#maxHP').value)||1;
        character.armorClass = parseInt(qs('#armorClass').value)||0;
        character.speed      = parseInt(qs('#speed').value)||0;
        character.notes      = qs('#notes').value || '';
        character.coins.pp = parseFloat(qs('#pp').value)||0; character.coins.gp = parseFloat(qs('#gp').value)||0; character.coins.sp = parseFloat(qs('#sp').value)||0; character.coins.cp = parseFloat(qs('#cp').value)||0;
        const encoded = encodeCharacter();
        try{ if (navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(encoded); }catch(e){}
        localStorage.setItem('d20_character', encoded);
        alert((translationsObj[currentLanguage] && translationsObj[currentLanguage].savedMsg) || 'Character encoded and copied to clipboard!');
    }

    function loadCharacter(){
        const stored = localStorage.getItem('d20_character'); let data = null; if (stored) data = decodeCharacter(stored);
        if (!data){
            const pasted = prompt((translationsObj[currentLanguage] && translationsObj[currentLanguage].loadPrompt) || 'Paste encoded character data:'); if (!pasted) return;
            data = decodeCharacter(pasted); if (!data){ alert((translationsObj[currentLanguage] && translationsObj[currentLanguage].errorMsg) || 'Decoding error. Check the string.'); return; }
        }
        try{
            if (data.info)  character.info  = Object.assign(character.info, data.info);
            if (data.stats) character.stats = Object.assign(character.stats, data.stats);
            if (data.hp)    character.hp    = Object.assign(character.hp, data.hp);
            if (data.coins) character.coins = Object.assign(character.coins, data.coins);
            character.skills    = Array.isArray(data.skills)?data.skills:character.skills;
            character.spells    = Array.isArray(data.spells)?data.spells:character.spells;
            character.inventory = Array.isArray(data.inventory)?data.inventory:character.inventory;
            character.armorClass = data.armorClass || character.armorClass;
            character.speed      = data.speed || character.speed;
            character.notes      = data.notes || character.notes;
            qs('#charName').value = character.info.name || '';
            qs('#charRace').value = character.info.race || '';
            qs('#charClass').value = character.info.class || '';
            ['Str','Dex','Con','Int','Wis','Cha'].forEach(k=>{ const el=document.getElementById('stat'+k); if(el) el.value = character.stats[k] || 10; });
            updateStatModifiers();
            qs('#currentHP').value = character.hp.current || 0; qs('#maxHP').value     = character.hp.max || 1; updateHealthBar();
            qs('#armorClass').value = character.armorClass || 0; qs('#speed').value      = character.speed || 0; qs('#notes').value      = character.notes || '';
            qs('#pp').value = character.coins.pp || 0; qs('#gp').value = character.coins.gp || 0; qs('#sp').value = character.coins.sp || 0; qs('#cp').value = character.coins.cp || 0;
            renderSkills(); renderSpells(); renderInventory(); updateInventoryTotal();
            alert((translationsObj[currentLanguage] && translationsObj[currentLanguage].loadedMsg) || 'Character loaded!');
        }catch(e){ alert((translationsObj[currentLanguage] && translationsObj[currentLanguage].errorMsg) || 'Decoding error. Check the string.'); }
    }

    // wire up handlers
    function wireUp(){
        qsa('.stat-value').forEach(inp=> inp.addEventListener('input', updateStatModifiers));
        const curHP = qs('#currentHP'); if (curHP) curHP.addEventListener('input', updateHealthBar);
        const maxHP = qs('#maxHP'); if (maxHP) maxHP.addEventListener('input', updateHealthBar);
        const newSkillName = qs('#newSkillName'); if (newSkillName) newSkillName.addEventListener('input', onNewSkillNameInput);
        const addSkillBtn = qs('#addSkillBtn'); if (addSkillBtn) addSkillBtn.addEventListener('click', addSkill);
        const newSpellName = qs('#newSpellName'); if (newSpellName) newSpellName.addEventListener('input', onNewSpellNameInput);
        const addSpellBtn = qs('#addSpellBtn'); if (addSpellBtn) addSpellBtn.addEventListener('click', addSpell);
        const itemName = qs('#ItemName'); if (itemName) itemName.addEventListener('input', onNewItemNameInput);
        const addItemBtn = qs('#addItemBtn'); if (addItemBtn) addItemBtn.addEventListener('click', addItem);
        ['pp','gp','sp','cp'].forEach(id=>{ const el=qs('#'+id); if(el) el.addEventListener('input', updateInventoryTotal); });
        const saveBtn = qs('#saveBtn'); if (saveBtn) saveBtn.addEventListener('click', saveCharacter);
        const loadBtn = qs('#loadBtn'); if (loadBtn) loadBtn.addEventListener('click', loadCharacter);
        updateStatModifiers(); updateHealthBar(); renderSkills(); renderSpells(); renderInventory(); updateInventoryTotal();
    }

    initTabs(); initLanguage(); wireUp(); updateLanguage(); applyEditMode();

    // ---------- Unified toggles: tooltips, lens, center toast ----------
    function showCenterToast(text, ms = 1000) {
        const el = document.createElement('div'); el.className = 'center-toast'; el.textContent = text; document.body.appendChild(el);
        void el.offsetWidth; el.classList.add('show');
        setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>{ if (el && el.parentNode) el.parentNode.removeChild(el); },300); }, ms);
    }
    function createInlineTooltip(container, text) {
        let tip = container.querySelector('.inline-tooltip');
        if (!tip) { tip = document.createElement('div'); tip.className = 'inline-tooltip'; container.appendChild(tip); }
        tip.textContent = text; return tip;
    }
    function moveLensTo(toggleRoot, targetEl) {
        const lens = toggleRoot.querySelector('.lens'); if (!lens || !targetEl) return;
        const rootRect = toggleRoot.getBoundingClientRect(); const targetRect = targetEl.getBoundingClientRect();
        const centerX = (targetRect.left + targetRect.right) / 2 - rootRect.left; const centerY = (targetRect.top + targetRect.bottom) / 2 - rootRect.top;
        lens.style.left = (centerX - lens.offsetWidth / 2) + 'px'; lens.style.top  = (centerY - lens.offsetHeight / 2) + 'px';
    }

    // expose API
    window.d20 = { character, setLanguage, saveCharacter, loadCharacter, addSkill, addSpell, addItem };

    // autosize notes
    const notes = document.getElementById('notes'); if (notes){ notes.style.overflow = 'hidden'; notes.style.resize = 'none'; const autoNotes = ()=> autosizeDescription(notes); notes.addEventListener('input', autoNotes); setTimeout(autoNotes, 0); }

})(); 

</script>
<script>
(function(){
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));

  function showCenterToast(text, ms = 1000) {
    const el = document.createElement('div');
    el.className = 'center-toast';
    el.textContent = text;
    document.body.appendChild(el);
    requestAnimationFrame(()=> el.classList.add('show'));
    setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=> el.remove(), 220); }, ms);
  }

  function createInlineTooltip(root, text) {
    let tip = root.querySelector('.inline-tooltip');
    if (!tip) {
      tip = document.createElement('div');
      tip.className = 'inline-tooltip';
      root.appendChild(tip);
    }
    tip.textContent = text;
    return tip;
  }

  function moveLensTo(root, target) {
    const lens = root.querySelector('.lens');
    if (!lens || !target) return;
    const rootRect = root.getBoundingClientRect();
    const tRect = target.getBoundingClientRect();
    const cx = (tRect.left + tRect.right) / 2 - rootRect.left;
    const cy = (tRect.top + tRect.bottom) / 2 - rootRect.top;
    lens.style.left = (cx - lens.offsetWidth / 2) + 'px';
    lens.style.top  = (cy - lens.offsetHeight / 2) + 'px';
  }

  function updateAddFormsVisibility(isRead) {
    const addIds = ['#skillsAdd', '#spellsAdd', '#itemsAdd'];
    addIds.forEach(id => {
      const el = qs(id);
      if (!el) return;
      if (isRead) {
        el.dataset._display = el.style.display || '';
        el.style.display = 'none';
        el.setAttribute('aria-hidden', 'true');
      } else {
        const prev = el.dataset._display || '';
        el.style.display = prev || 'block';
        el.removeAttribute('aria-hidden');
      }
    });
  }

  // кнопка редактирования/чтения листа
  (function setupMode(){
    const root = qs('#modeToggle');
    if (!root) return;
    const circles = Array.from(root.querySelectorAll('.circle'));
    // visual: empty circles
    circles.forEach(c => { c.textContent = ''; });

    function setMode(mode, announce = true) {
      root.dataset.state = mode;
      circles.forEach(c => {
        const m = c.dataset.mode;
        if (m === mode) { c.classList.add('active'); c.classList.remove('inactive'); }
        else { c.classList.remove('active'); c.classList.add('inactive'); }
      });
      const active = root.querySelector('.circle.active') || circles[0];
      moveLensTo(root, active);

      const isRead = mode === 'read';
      if (isRead) document.documentElement.classList.add('readonly');
      else document.documentElement.classList.remove('readonly');

      updateAddFormsVisibility(isRead);

      if (announce) showCenterToast(isRead ? 'Режим чтения' : 'Режим редактирования', 1000);
    }

    setMode(root.dataset.state === 'read' ? 'read' : 'edit', false);

    root.addEventListener('click', ()=>{
      const newState = (root.dataset.state === 'read') ? 'edit' : 'read';
      setMode(newState, true);
    });

    // tooltip on hover for the control (shows current state)
    root.addEventListener('mouseenter', ()=> createInlineTooltip(root, root.dataset.state === 'read' ? 'Режим чтения' : 'Режим редактирования'));
    root.addEventListener('mouseleave', ()=> { const t = root.querySelector('.inline-tooltip'); if (t) t.remove(); });

    root.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); root.click(); } });
    window.addEventListener('resize', ()=> moveLensTo(root, root.querySelector('.circle.active') || circles[0]));
    requestAnimationFrame(()=> moveLensTo(root, root.querySelector('.circle.active') || circles[0]));
  })();

  // кнопка переключения языков
  (function setupLang(){
    const root = qs('#langToggle');
    if (!root) return;
    const circles = Array.from(root.querySelectorAll('.circle'));
    if (circles.length < 4) return; // expect 4

    // normalize data-lang if missing
    circles.forEach(c => {
      if (!c.dataset.lang) {
        const txt = (c.textContent || '').trim().toLowerCase();
        if (txt.startsWith('ru')) c.dataset.lang = 'ru';
        else if (txt.startsWith('en')) c.dataset.lang = 'en';
        else if (txt.startsWith('es')) c.dataset.lang = 'es';
        else if (txt.startsWith('fr')) c.dataset.lang = 'fr';
      }
    });

    const order = circles.map(c => c.dataset.lang).filter(Boolean);
    if (!order.length) return;
    let selected = root.dataset.selected || order[0];

    function setLang(lang, showToast = true) {
      selected = lang;
      root.dataset.selected = lang;
      circles.forEach(c => {
        if (c.dataset.lang === lang) { c.classList.add('active'); c.classList.remove('inactive'); }
        else { c.classList.remove('active'); c.classList.add('inactive'); }
      });
      moveLensTo(root, root.querySelector('.circle.active') || circles[0]);

      // call existing i18n functions if available
      if (typeof setLanguage === 'function') {
        try { setLanguage(lang); } catch(e) {}
      } else if (window.d20 && typeof window.d20.setLanguage === 'function') {
        try { window.d20.setLanguage(lang); } catch(e) {}
      } else {
        try { window.currentLanguage = lang; if (typeof updateLanguage === 'function') updateLanguage(); } catch(e) {}
      }

      if (showToast) showCenterToast('Язык: ' + lang.toUpperCase(), 900);
    }

    // remove per-circle click handlers: only root click cycles languages
    circles.forEach(c=>{
      // keep visible label RU/EN/ES/FR
      c.style.cursor = 'default';
      c.addEventListener('mouseenter', ()=> {
        // tooltip shows currently selected language (not per-circle selection)
        // but we keep helpful hover text referencing this circle for clarity
        const current = root.dataset.selected || selected;
        createInlineTooltip(root, 'Выбран язык: ' + (current || '').toUpperCase());
      });
      c.addEventListener('mouseleave', ()=> { const t = root.querySelector('.inline-tooltip'); if (t) t.remove(); });
    });

    // root click cycles only
    root.addEventListener('click', () => {
      const idx = order.indexOf(selected);
      const next = order[(idx + 1) % order.length];
      setLang(next, true);
    });

    // root hover shows selected language
    root.addEventListener('mouseenter', ()=> {
      const cur = root.dataset.selected || selected;
      createInlineTooltip(root, 'Выбран язык: ' + (cur || '').toUpperCase());
    });
    root.addEventListener('mouseleave', ()=> { const t = root.querySelector('.inline-tooltip'); if (t) t.remove(); });

    root.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); root.click(); } });

    setLang(selected, false);
    window.addEventListener('resize', ()=> moveLensTo(root, root.querySelector('.circle.active') || circles[0]));
    requestAnimationFrame(()=> moveLensTo(root, root.querySelector('.circle.active') || circles[0]));
  })();

})();
</script>
</body>
</html>
</DOCUMENT>
